From 108676c3f26be6c873db0dd8754063699908727b Mon Sep 17 00:00:00 2001
From: Philip Hands <phil@hands.com>
Date: Sat, 3 Oct 2020 21:10:03 +0200
Subject: [PATCH 5/8] tidy up test of $SCRATCH_DIR creation

SSH-Copy-ID-Upstream: 2d8b22d96c105d87743ffe8874887b06f8989b93
---
 contrib/ssh-copy-id | 14 ++++++--------
 1 file changed, 6 insertions(+), 8 deletions(-)

diff --git a/contrib/ssh-copy-id b/contrib/ssh-copy-id
index 6b8aca7d..d7c3a61f 100644
--- a/contrib/ssh-copy-id
+++ b/contrib/ssh-copy-id
@@ -290,17 +290,15 @@ installkeys_via_sftp() {
 
 
 # create a scratch dir for any temporary files needed
-SCRATCH_DIR=$(mktemp -d ~/.ssh/ssh-copy-id.XXXXXXXXXX)
-if test $? -ne 0 || test "x$SCRATCH_DIR" = "x" ; then
-  printf '%s: ERROR: mktemp failed\n' "$0" >&2
-  exit 1
-fi
-chmod 0700 $SCRATCH_DIR
-if [ -d "$SCRATCH_DIR" ] ; then
+if SCRATCH_DIR=$(mktemp -d ~/.ssh/ssh-copy-id.XXXXXXXXXX) &&
+    [ "$SCRATCH_DIR" ] && [ -d "$SCRATCH_DIR" ]
+then
+  chmod 0700 "$SCRATCH_DIR"
   SCRATCH_CLEANUP="rm -rf \"$SCRATCH_DIR\""
+  #shellcheck disable=SC2064
   trap "$SCRATCH_CLEANUP" EXIT TERM INT QUIT
 else
-  printf '%s: ERROR: Required scratch directory (%s) was not created\n' "$0" "$SCRATCH_DIR" >&2
+  printf '%s: ERROR: failed to create required temporary directory under ~/.ssh\n' "$0" >&2
   exit 1
 fi
 
-- 
2.28.0

